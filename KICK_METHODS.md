# Методы кика персонажей

## Типы кика

### 1. Мягкий кик (Soft)
- **Что делает**: Только обновляет `online = 0` в базе данных
- **Когда использовать**: Когда нужно просто обновить статус в админ панели
- **Эффективность**: Низкая - игрок может остаться в игре

### 2. Жесткий кик (Hard)
- **Что делает**: 
  - Обновляет `online = 0`
  - Устанавливает `logout_time = текущее время`
- **Когда использовать**: Когда нужно более серьезное отключение
- **Эффективность**: Средняя - может отключить игрока при следующей проверке сервера

### 3. Принудительный кик (Force)
- **Что делает**: Применяет ВСЕ методы одновременно:
  - Обновляет статус персонажа
  - Инвалидирует сессию персонажа
  - Телепортирует в безопасное место (Оргриммар)
  - Очищает кэш персонажа
  - Отключает весь аккаунт
  - Создает временный бан на 1 минуту
  - Пытается использовать SOAP API (если настроен)

## Агрессивные методы принудительного кика

### Метод 1: SOAP API
```php
// Отправляет команду .kick {player} {reason} на игровой сервер
$soapClient->executeCommand(['command' => ".kick {$characterName} {$reason}"]);
```

### Метод 2: Инвалидация сессии
```php
// Обновляет время последнего входа
DB::table('characters')->where('guid', $characterGuid)->update([
    'last_login' => time() - 3600,
    'logout_time' => time(),
    'online' => 0
]);
```

### Метод 3: Телепорт в безопасное место
```php
// Телепортирует персонажа в Оргриммар
DB::table('characters')->where('guid', $characterGuid)->update([
    'position_x' => 1676.21,
    'position_y' => -4315.29,
    'position_z' => 61.52,
    'map' => 1,
    'zone' => 1637
]);
```

### Метод 4: Очистка кэша
```php
// Очищает кэш персонажа в Redis
$redis->del("character:{$characterGuid}");
$redis->del("character:{$characterGuid}:*");
```

### Метод 5: Отключение аккаунта
```php
// Обновляет данные аккаунта
DB::connection('mysql_auth')->table('account')->where('id', $accountId)->update([
    'last_login' => time() - 3600,
    'last_ip' => '127.0.0.1'
]);

// Отключает всех персонажей аккаунта
DB::connection('mysql_char')->table('characters')
    ->where('account', $accountId)
    ->update(['online' => 0, 'logout_time' => time()]);
```

### Метод 6: Временный бан
```php
// Создает временный бан на 1 минуту
DB::connection('mysql_auth')->table('account_banned')->insert([
    'id' => $accountId,
    'bandate' => time(),
    'unbandate' => time() + 60,
    'bannedby' => 'Admin Panel',
    'banreason' => "Force kick: {$reason}",
    'active' => 1
]);
```

## Автоматическое снятие бана

Система автоматически снимает временный бан через 1 минуту:

1. **Через очередь Laravel** (если настроена):
   ```php
   \App\Jobs\UnbanAccount::dispatch($accountId)->delay(now()->addSeconds(60));
   ```

2. **Через таблицу задач** (если очередь не настроена):
   ```php
   DB::table('scheduled_tasks')->insert([
       'task' => 'unban_account',
       'data' => json_encode(['account_id' => $accountId]),
       'scheduled_at' => date('Y-m-d H:i:s', $unbanTime)
   ]);
   ```

## Логирование

Все действия кика логируются:

```php
Log::info("Character kick: {$character->name} (GUID: {$id}) by admin " . Auth::user()->username . 
          " - Type: {$kickType}, Reason: {$reason}");
```

## Рекомендации по использованию

1. **Мягкий кик** - для тестирования или когда игрок уже вышел
2. **Жесткий кик** - для обычных случаев модерации
3. **Принудительный кик** - для проблемных игроков, которые не отключаются обычными методами

## Устранение неполадок

Если кик не работает:

1. Проверьте логи Laravel: `storage/logs/laravel.log`
2. Убедитесь, что база данных доступна
3. Проверьте права доступа к таблицам
4. Для SOAP - убедитесь, что сервер настроен правильно
5. Проверьте, что Redis работает (если используется для кэша)

## Безопасность

- Все действия требуют админских прав
- Временные баны автоматически снимаются
- Все действия логируются для аудита
- SOAP соединение защищено аутентификацией
